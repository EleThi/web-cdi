<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    {% load staticfiles %}

    <title>Words and Sentences CDI</title>
    <meta name="description" content="English Words and Sentences CDI form">
    <meta name="author" content="Ashwin Paranjape">

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="http://getbootstrap.com/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://getbootstrap.com/dist/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="{% static 'cdi_forms/selectize.js' %}"></script>
    <script src="{% static 'cdi_forms/bootstrap-datepicker.js' %}"></script>
    <link rel='stylesheet' href="{% static 'cdi_forms/selectize.bootstrap3.css' %}">
    <link rel='stylesheet' href="{% static 'cdi_forms/datepicker.css' %}">
    <link rel="stylesheet" href="http://getbootstrap.com/assets/css/docs.min.css" />
    <link rel='stylesheet' href="{% static 'cdi_forms/base.css' %}">

        <!--.alternate-color :nth-child(odd){
              background-color:#ddd;
        }
        .alternate-color :nth-child(even){
              background-color:#fff;
        }-->

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<style>
    .axis {
    font: 12px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }



</style>
<body>

  <div class = "row"> 
    <div class="col-md-6 text-center" id="predicted_chart"></div>
    <h2><div class="col-md-6 text-center" id="num_words_text"></div></h2>
  </div>

  <div class = "row"> 
    <div class="text-center" id="categories_charts"></div>
    <h4><div class="row text-center" id="best_categories"></div></h4>
  </div>

  <div class = "row text-center"> 
    <h2><div id="hardest_words"></div><h2>
  </div>


<script src="http://d3js.org/d3.v3.js"></script>
<script src="https://cdn.jsdelivr.net/lodash/4.17.2/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.3/d3-queue.min.js"></script>

<script>
  var graph_height = 500;
  var graph_width = 500;
  var stroke_thickness = 4;

  var raw_data = '{{ objects |escapejs }}';
  var root = JSON.parse(raw_data);
  root.age = JSON.parse('{{ age }}')[0];
  root.completed = '{{ completed }}';
  root.hash_id = '{{ hash_id }}';
  root.instrument_name = '{{ instrument_name }}';



  var words = root.filter(function(d) { return d.item_type == "word"; });

  $.each(words, function(index, value){
    value.num_value = 'neither';
    if (root.instrument_name.indexOf('WS') > -1) {
      if (value.prefilled_value) {
        value.num_value = 'produces';
      }
    } else if (root.instrument_name.indexOf('WG') > -1) {
      if (value.choices[0][2]) {
        value.num_value = 'understands';
      } else if (value.choices[1][2]) {
        value.num_value = 'produces';
      }
    }

  });

  var raw_words_understood = words.filter(function(d) { return d.num_value == 'understands' ; }).length;
  var words_understood = words.filter(function(d) { return d.num_value == 'produces' | d.num_value == 'understands' ; }).length;
  var words_produced = words.filter(function(d) { return (d.num_value == 'produces'); }).length;


  if (words_produced > 0 & raw_words_understood > 0) {
    var num_words = "My baby says " + words_produced + " words and understands " + words_understood + " words."
  }

  if (words_produced > 0 & raw_words_understood == 0) {
    var num_words = "My baby says " + words_produced + " words."
  }

  if (words_produced == 0 & raw_words_understood > 0) {
    var num_words = "My baby understands " + words_understood + " words."
  }

  if (words_produced > 0 | raw_words_understood > 0) {
    document.getElementById("num_words_text").innerHTML = num_words;
  }

  var categorySize = d3.nest()
  .key(function(d) { return d.category; })
  .key(function(d) { return d.num_value; })
  .rollup(function(v) { return v.length; })
  .entries(words);

  var word_categories;
  var prod_graph_width = graph_width;
  var comp_graph_width = graph_width;


  d3.csv("{% static 'graph_data/word_categories.csv' %}", function(data) {
    word_categories = data;
    var list_names = objectMap(categorySize,'key')
    updateCategoryInfo();

    $.each(word_categories, function(index){
      var category_id = word_categories[index].id;
      var name_location = list_names.indexOf(category_id)
      if (name_location > -1 ) {
        categorySize[name_location].category_name = word_categories[index].category;
      }
    });

    if (raw_words_understood == 0 ) {
      prod_graph_width = graph_width*2;
    }

    if (words_produced == 0 ) {
      comp_graph_width = graph_width*2;
    }

    if (raw_words_understood > 0) {
      plotFlippedPropUnderstood();
    }

    if (words_produced > 0) {
      plotFlippedPropProduced();
    }


    bestCategories();

  });

  function objectMap (obj, variable) {
    var values = []
    i = 0;
    $.each(obj, function(index){ 
      values[i] = obj[index][variable]
      i = i + 1;
    });
    return values;
  }

  var colors = d3.scale.category20();

  function updateCategoryInfo() {

  var category_colors = colorHue(categorySize.length)
   $.each(categorySize, function(index, value){
    value.color = category_colors[index]
    value.neither = 0;
    value.understands = 0;
    value.produces = 0;
    
    for (var i = 0; i < categorySize[index].values.length; i++) {
      var current_val = categorySize[index].values[i]
      if(current_val.key == 'neither') {
        value.neither = current_val.values;
      }
      if(current_val.key == 'understands') {
        value.understands = current_val.values;
      }
      if(current_val.key == 'produces') {
        value.produces = current_val.values;
      }

    }
    
    
    value.num_all = value.neither + value.understands + value.produces
    value.prop_understood = 100*(value.understands + value.produces)/(value.num_all)
    value.prop_produced = 100*(value.produces)/(value.num_all)
  });
  }

  function shuffle(array) {
    var currentIndex = array.length, temporaryValue, randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }

  function colorHue(n) {
    var hues = []
    var step_count = 360/n

    for (var i = 0; i < n; i++) {
      hue = Math.round(15 + i*step_count);
      hues.push(d3.hcl(hue, 100, 60));
      }
    return shuffle(hues);
  }

  function plotFlippedPropUnderstood() {
    var margin = {top: 20, right: 20, bottom: 60, left: 200},
    width = comp_graph_width - margin.left - margin.right,
    height = graph_height - margin.top - margin.bottom;

    var x = d3.scale.linear().range([0, width]);

    var y = d3.scale.ordinal().rangeRoundBands([0, height], .05);

    var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(4)
    .outerTickSize(0);

    var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

    var chart_understood = d3.select("#categories_charts").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", 
      "translate(" + margin.left + "," + margin.top + ")");

    x.domain([0, d3.max(categorySize, function(d) { return d.prop_understood; })]);
    y.domain(categorySize.map(function(d) { return d.category_name; }));


    chart_understood.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .selectAll(".tick text")
    .style("text-anchor", "end")
    .attr("dx", "0.4em")
    .attr("dy", ".8em")
    //.attr("transform", "rotate(-90)" );

    chart_understood.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    //.append("text")
    //.attr("transform", "rotate(-90)")
    .selectAll(".tick text")
    .attr("dx", "-0.8em")
    .call(wrap, 200)
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end");

    chart_understood.append("text")             
    .attr("transform",
          "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
    .style("text-anchor", "middle")
    .text("Percentage of Words Understood (%)");

    chart_understood.selectAll("bar")
    .data(categorySize)
    .enter().append("rect")
    .attr("fill",function(d,i) { return d3.hcl(categorySize[i].color); })
    .attr("x", function(d) { return 0; })
    .attr("width", function(d) { return x(d.prop_understood); })
    .attr("y", function(d) { return y(d.category_name); })
    .attr("height", y.rangeBand());
  }


  function plotFlippedPropProduced() {
    var margin = {top: 20, right: 20, bottom: 60, left: 200},
    width = prod_graph_width - margin.left - margin.right,
    height = graph_height - margin.top - margin.bottom;

    var x = d3.scale.linear().range([0, width]);

    var y = d3.scale.ordinal().rangeRoundBands([0, height], .05);

    var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(4)
    .outerTickSize(0);

    var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .outerTickSize(0);

    var chart_produced = d3.select("#categories_charts").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", 
      "translate(" + margin.left + "," + margin.top + ")");

    x.domain([0, d3.max(categorySize, function(d) { return d.prop_produced; })]);
    y.domain(categorySize.map(function(d) { return d.category_name; }));


    chart_produced.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .selectAll(".tick text")
    .style("text-anchor", "end")
    .attr("dx", "0.4em")
    .attr("dy", ".8em");

    chart_produced.append("text")             
    .attr("transform",
          "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
    .style("text-anchor", "middle")
    .text("Percentage of Words Spoken (%)");

    chart_produced.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .selectAll(".tick text")
    .attr("dx", "-0.8em")
    .call(wrap, 200)
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end");

    chart_produced.selectAll("bar")
    .data(categorySize)
    .enter().append("rect")
    //.attr("fill",function(d,i){return colors(i)})
    .attr("fill",function(d,i) { return d3.hcl(categorySize[i].color); })
    .attr("x", function(d) { return 0; })
    .attr("width", function(d) { return x(d.prop_produced); })
    .attr("y", function(d) { return y(d.category_name); })
    .attr("height", y.rangeBand());
  }

  var bestProdCat_num = 0;
  var bestCompCat_num = 0;
  var bestProdCat;
  var bestCompCat;

  function bestCategories() {


    for (var i = 0; i < categorySize.length; i++) {
      if (categorySize[i].prop_produced > bestProdCat_num & words_produced > 0) {
        bestProdCat_num = categorySize[i].prop_produced;
        bestProdCat = categorySize[i].category_name;
      }

      if (categorySize[i].prop_understood > bestCompCat_num & raw_words_understood > 0) {
        bestCompCat_num = categorySize[i].prop_understood;
        bestCompCat = categorySize[i].category_name;
      }


    }


    if (typeof(bestProdCat) !== 'undefined') {

      document.getElementById("best_categories").innerHTML = document.getElementById("best_categories").innerHTML + 'My baby says the most words in the "' + bestProdCat + '" category.<br>';
    }

    if (typeof(bestCompCat) !== 'undefined') {

      document.getElementById("best_categories").innerHTML = document.getElementById("best_categories").innerHTML + 'My baby understands the most words in the "' + bestCompCat + '" category.<br>';
    }


  }

  var aoa_data;
  var words_prod;
  var words_comp;
  var aoa_data_prod;
  var aoa_data_comp;
  var aoa_prod_combined;
  var aoa_comp_combined;
  var high_prod_aoa;
  var high_comp_aoa;
  var high_prod_word;
  var high_comp_word;

  function join(lookupTable, mainTable, lookupKey, mainKey, select) {
    var l = lookupTable.length,
    m = mainTable.length,
    lookupIndex = [],
    output = [];
    for (var i = 0; i < l; i++) { // loop through l items
      var row = lookupTable[i];
        lookupIndex[row[lookupKey]] = row; // create an index for lookup table
      }
    for (var j = 0; j < m; j++) { // loop through m items
      var y = mainTable[j];
        var x = lookupIndex[y[mainKey]]; // get corresponding row from lookupTable
        output.push(select(y, x)); // select only the columns you need
      }
    return output;
  };

  d3.csv("{% static 'graph_data/english_aoas.csv' %}", function(data) {
    aoa_data = data;

    words_prod = words.filter(function(d) { return (d.num_value == 'produces'); });
    words_comp = words.filter(function(d) { return (d.num_value == 'understands'); });

    aoa_data_prod = aoa_data.filter(function(d) { return (d.measure == 'produces'); });
    aoa_data_comp = aoa_data.filter(function(d) { return (d.measure == 'understands'); });

    aoa_prod_combined = join(aoa_data_prod, words_prod, "words", "definition", function(word, aoa) {
      return {
        word: word.definition,
        aoa: (aoa !== undefined) ? parseInt(aoa.age) : null
      };
    });

    aoa_comp_combined = join(aoa_data_comp, words_comp, "words", "definition", function(word, aoa) {
      return {
        word: word.definition,
        aoa: (aoa !== undefined) ? parseInt(aoa.age) : null
      };
    });

    if (aoa_prod_combined.length > 0) {
      high_prod_aoa = 0

      for (var i = 0; i < aoa_prod_combined.length; i++) {
        if (aoa_prod_combined[i].aoa > high_prod_aoa) {
          high_prod_aoa = aoa_prod_combined[i].aoa;
          high_prod_word = aoa_prod_combined[i].word;
        }

      }
    }

    if (aoa_comp_combined.length > 0) {
      high_comp_aoa = 0

      for (var j = 0; j < aoa_comp_combined.length; j++) {
        if (aoa_comp_combined[j].aoa > high_comp_aoa) {
          high_comp_aoa = aoa_comp_combined[j].aoa;
          high_comp_word = aoa_comp_combined[j].word;
        }

      }
    }


    if (typeof(high_prod_word) !== 'undefined') {

      document.getElementById("hardest_words").innerHTML = document.getElementById("hardest_words").innerHTML + 'The hardest word my baby says is "' + high_prod_word + '".<br>';
    }

    if (typeof(high_comp_word) !== 'undefined') {

      document.getElementById("hardest_words").innerHTML = document.getElementById("hardest_words").innerHTML + 'The hardest word my baby understands is "' + high_comp_word + '".<br>';
    }




  });

  var predicted_vocab;
  var pred_prod_min;
  var pred_comp_min;
  var pred_prod_quant;
  var pred_comp_quant;
  var quant_prod;
  var quant_age_loc_prod;
  var adjust_prod;
  var quant_comp;
  var quant_age_loc_comp;
  var adjust_comp;
  var adjusted_quant_prod = [];
  var adjusted_quant_comp = [];
  var current_vocab = [];


  if ((root.age > 30 | root.age < 16) & root.instrument_name.indexOf('WS') > -1) {
    document.getElementById("predicted_chart").innerHTML = "<h4><font color = '#008000'> Sorry but it looks like your baby is outside of our age range for predicting vocabulary size! This version of the CDI assessment is for children between 16 to 30 months of age </font></h4>"

  } else if ((root.age > 18 | root.age < 8) & root.instrument_name.indexOf('WG') > -1) {
    document.getElementById("predicted_chart").innerHTML = "<h4><font color = '#008000'> Sorry but it looks like your baby is outside of our age range for predicting vocabulary size! This version of the CDI assessment is for children between 8 to 18 months of age </font></h4>"

  } else {
    d3.csv("{% static 'graph_data/predicted_vocab_English.csv' %}", function(data) {
  
      predicted_vocab = data;
      current_ages = predicted_vocab.filter(function(d) { return (parseInt(d.age) == root.age); });
  
      findQuantile();
  
      quant_prod = predicted_vocab.filter(function(d) { return d.percentile == pred_prod_quant & d.measure == "production"; });
      quant_age_loc_prod = objectMap(quant_prod,'age').indexOf(root.age.toString());
      adjust_prod = (words_produced/(words.length)) - quant_prod[quant_age_loc_prod].pred;
      for (var i = 0; i < quant_prod.length; i++) {
        raw_adjusted_num = parseFloat(quant_prod[i].pred) + adjust_prod;
        adjusted_num = (raw_adjusted_num < 0)? 0 : ((raw_adjusted_num > 1)? 1 : raw_adjusted_num)
        adjusted_quant_prod[i] = {"pred" : adjusted_num , "age": (parseFloat(quant_prod[i].age))};
      }
      current_vocab.push({"age": root.age, "vocab": 100*words_understood/(words.length)});
  
  
      if (raw_words_understood > 0) {
          quant_comp = predicted_vocab.filter(function(d) { return d.percentile == pred_prod_quant & d.measure == "comprehension"; });
          quant_age_loc_comp = objectMap(quant_comp,'age').indexOf(root.age.toString());
          adjust_comp = (words_understood/(words.length)) - quant_comp[quant_age_loc_comp].pred;
          for (var i = 0; i < quant_comp.length; i++) {
            raw_adjusted_num = parseFloat(quant_comp[i].pred) + adjust_comp;
            adjusted_num = (raw_adjusted_num < 0)? 0 : ((raw_adjusted_num > 1)? 1 : raw_adjusted_num)
            adjusted_quant_comp[i] = {"pred" : adjusted_num , "age": (parseFloat(quant_comp[i].age))};
          }
        current_vocab.push({"age": root.age, "vocab": 100*words_produced/(words.length)});
      }
  
  
  
      plotPredictData();
  
    });
  }

  function findQuantile() {
    // if (words_produced > 0) {
    //   pred_prod_min = 1000;
    //   word_prod_prop = words_produced/(words.length);
    //   current_ages_prod = predicted_vocab.filter(function(d) { return (parseInt(d.age) == root.age & d.measure == "production"); });


    //   for (var j = 0; j < current_ages_prod.length; j++) {
    //     current_diff = Math.abs(parseInt(current_ages_prod[j].pred) - word_prod_prop);

    //     if (pred_prod_min > current_diff) {
    //       pred_prod_min = current_diff;
    //       pred_prod_quant = current_ages_prod[j].percentile;
    //     }

    //   }
    // } else {
    //   pred_prod_quant = 10
    // }

    pred_prod_quant = 50

    if (raw_words_understood > 0) {
      // pred_comp_min = 1000;
      // word_comp_prop = raw_words_understood/(words.length);
      // current_ages_comp = predicted_vocab.filter(function(d) { return (parseInt(d.age) == root.age & d.measure == "comprehension"); });


      // for (var i = 0; i < current_ages_comp.length; i++) {
      //   current_diff = Math.abs(parseInt(current_ages_comp[i].pred) - word_comp_prop);

      //   if (pred_comp_min > current_diff) {
      //     pred_comp_min = current_diff;
      //     pred_comp_quant = current_ages_prod[i].percentile;
      //   }

      // }

      pred_comp_quant = 50
    }
  }

  function plotPredictData() {
    var margin = {top: 20, right: 150, bottom: 60, left: 80},
      width = graph_width - margin.left - margin.right,
      height = graph_height - margin.top - margin.bottom;

    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    var xAxis = d3.svg.axis().scale(x)
      .orient("bottom")
      .ticks(5)
      .outerTickSize(0);
     
    var yAxis = d3.svg.axis().scale(y)
      .orient("left")
      .ticks(5)
      .outerTickSize(0);

    var valueline = d3.svg.line()
      .x(function(d) { return x(d.age); })
      .y(function(d) { return y(100 * d.pred); });

    var pred_chart = d3.select("#predicted_chart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(adjusted_quant_prod, function(d) { return d.age; }));
    y.domain([0, 100]);
   
    pred_chart.append("path")  
      .attr("class", "line")
      .style("stroke", "#9471f2")
      .style("stroke-width", stroke_thickness)
      .style("fill", "none")
      .attr("d", valueline(adjusted_quant_prod));

    pred_chart.append("path")  
      .attr("class", "line")
      .style("stroke", "#FF9667")
      .style("stroke-width", stroke_thickness)
      .style("fill", "none")
      .attr("d", valueline(adjusted_quant_comp))
      .style("display", (root.age > 18)? "none": null);

    pred_chart.selectAll("dot")
        .data(current_vocab)
      .enter().append("circle")
        .attr("r", 6)
        .attr("cx", function(d) { return x(d.age); })
        .attr("cy", function(d) { return y(d.vocab); })
        .attr("fill", "#2DBC74");

    pred_chart.append("text")             
    .attr("transform",
          "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
    .style("text-anchor", "middle")
    .text("Age (in Months)");

    pred_chart.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left/2)
        .attr("x",0 - (height / 2))
        .attr("dy", "0.8em")
        .style("text-anchor", "middle")
        .text("% of Words on Test");

    pred_chart.append("text")
        .attr("y", 10 )
        .attr("x", width-10)
        .attr("dy", "0.8em")
        .attr("class", "legend")
        .style("text-anchor", "right")
        .style("fill", "#26985F")         
        .text("Current Vocabulary Size"); 

    pred_chart.append("text")
        .attr("y", 30 )
        .attr("x", width)
        .attr("dy", "0.8em")
        .attr("class", "legend")
        .style("text-anchor", "right")
        .style("fill", "#7B5FC9")         
        .text("% of Words Spoken"); 

    pred_chart.append("text")
        .attr("y", 50 )
        .attr("x", width-10)
        .attr("dy", "0.8em")
        .attr("class", "legend")
        .style("text-anchor", "right")
        .style("fill", "#DD6935")         
        .text("% of Words Understood")
        .style("display", (root.age > 18)? "none": null); 

    pred_chart.append("g")   
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);
   
    pred_chart.append("g")   
      .attr("class", "y axis")
      .call(yAxis);

  }

  function wrap(text, width) {
    text.each(function() {
      var text = d3.select(this),
          words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 0.9, // ems
          y = text.attr("y"),
          dx = parseFloat(text.attr("dx")),
          dy = parseFloat(text.attr("dy")),
          tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dx", dx + "em").attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > width) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dx", dx + "em").attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }


</script>
</body>
</html>