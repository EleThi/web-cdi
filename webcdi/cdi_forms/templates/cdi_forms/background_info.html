{% extends 'cdi_forms/cdi_base.html' %}

{% block nav_buttons %}
{% if not completed %}
<input name="btn-save" value="Save" class="btn btn-primary" type="button">
<input name="btn-next" value="Next" class="btn btn-primary" type="submit">
{% endif %}
{% endblock %}

{% block main %}
{% if background_form %}
<input type="hidden" name="background-info-form" value="background-info-form"/>
<div class="row">
    <h2>MacArthur-Bates Communicative Development Inventory</h2>
    <h4><div id = "instrument_age" style = "text-decoration: underline;"></p></div><br>
    <h4>Instructions for completing the language inventory</h4>
    <ul>
        <li> Try to complete the inventory when you have at least 30 quiet minutes, without interruptions. An example might be when your child is sleeping. </li>
        <li> You do not have to complete the inventory in one sitting. If you are interrupted, it is ok to put it down and come back to it when you have more time. </li>
        <li> Feel free to ask others (e.g. other family members, nanny, child care providers) to help you fill out this form. </li>
        <li> Please read all of the instructions on the inventory carefully, and make sure you complete all of the sections. </li>
    </ul>
    <p>For more information about the MB-CDI, <a href="http://mb-cdi.stanford.edu/">click here</a>.</p>
    <p>Thank you! We appreciate your time and effort!</p>
</div>
<br>
<div class="row">
    {% load crispy_forms_tags %}
    {% crispy background_form %}
</div>

<div class="row text-center">
    <input name="btn-save" value="Save" class="btn btn-primary" type="button">
    <input name="btn-next" value="Next" class="btn btn-primary" type="submit">
</div>
{% else %}
<p>Form unavailable. Contact admin. </p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    $('.enabler[value="True"]').each(function(index, e){
        if(e.checked){
            $(e).closest('.form-group').next('.dependent').css('display','block');
        }
        $(e).change(function(){
            $(e).closest('.form-group').next('.dependent').css('display','block');
        });
    });
    $('.enabler[value="False"]').each(function(index, e){
        if(e.checked){
            $(e).closest('.form-group').next('.dependent').css('display','none');
        }
        $(e).change(function(){
            $(e).closest('.form-group').next('.dependent').css('display','none');
        });
    });
    var $select = $('.make-selectize').selectize({
        maxItems :null,
    });

    $('#id_child_dob').datepicker()
        .on('changeDate', function() {
            getDiffinMonths();
        });
    {% if completed %}
        $('input').prop('disabled', True);
    {% endif %}

    history.pushState(null, null, document.URL);
    window.addEventListener('popstate', function () {
        history.pushState(null, null, document.URL);
    });

    $

    document.getElementById("id_age").disabled = true;

    function getDiffinMonths() {
        
        var b_date = new Date($('#id_child_dob').val());

        if (!isNaN(b_date.getTime()) && document.getElementById("id_child_dob").value != ''){
            console.log("Date valid");
            var t_date = new Date();

            var years_diff = t_date.getFullYear() - b_date.getFullYear();
            var months_diff_raw = t_date.getMonth() - b_date.getMonth();
            var months_diff = months_diff_raw >= 0 ? months_diff_raw : (years_diff >= 1? (months_diff_raw + 12): months_diff_raw);
            var days_diff_raw = t_date.getDate() - b_date.getDate();
            var days_diff = days_diff_raw >= 15 ? 1 : 0;

            var diff_in_months = years_diff*12 + months_diff + days_diff;

            if (diff_in_months > 0){

                document.getElementById("id_age").value = diff_in_months;
            }

        }
    };

    document.getElementById("id_child_dob").onchange = function() {getDiffinMonths()};
    getDiffinMonths();
    var instrument_name = "{{ title }}";

    window.onload = function() { addWarnings() };

    function addWarnings() {

        var instrument_name = "{{ title }}";
        var text = "For ".concat("{{ min_age }}","- to ", "{{ max_age }}", "-month-old children")
        var selected_ages = document.getElementById('hint_id_age');
        var hint = "<br><font color = '#3C763D' style = 'text-decoration: underline;'>Your child should be between ".concat("{{ min_age }}"," to ", "{{ max_age }}", " months of age.</font>")

/*       if ( instrument_name.indexOf("Words and Sentences") > -1 || instrument_name.indexOf("WS") > -1) {
            text = "For 16- to 30-month-old children";
            hint = "<br><font color = '#3C763D' style = 'text-decoration: underline;'>Your child should be between 16 to 30 months of age.</font>"
        } else if ( instrument_name.indexOf("Words and Gestures") > -1 || instrument_name.indexOf("WG") > -1 ) {
            text = "For 8- to 18-month-old children";
            hint = "<br><font color = '#3C763D' style = 'text-decoration: underline;'>Your child should be between 8 to 18 months of age.</font>"
        }*/
        document.getElementById("instrument_age").innerHTML = text;


        selected_ages.innerHTML = selected_ages.innerHTML + hint;
    }

    document.getElementById("id_birth_order").min = "1";
    document.getElementById("id_birth_order").max = "15";




</script>
{% endblock %}
